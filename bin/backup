#!/usr/bin/env bash

set -e

if ! grep solanum /etc/hosts > /dev/null; then
    exit 1
fi

mkdir -p /tmp/backup/

cp -r ~/.ssh/ /tmp/backup/ssh
cp -r ~/.gnupg/ /tmp/backup/gnupg
cp -r ~/.local/share/keepassxc/ /tmp/backup/keepassxc

pushd /tmp/backup
    tar -czf "backup-$(hostname)-$(date +"%Y%m%d-%H%M%S").tar.gz" ssh/ gnupg/ keepassxc/
    gpg --sign --encrypt --recipient kuisma.juho+github@gmail.com backup-*.gz
    scp ./*.asc solanum:/mnt/solanum/enc/backup/
popd

rm -rf /tmp/backup
